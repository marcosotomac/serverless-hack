org: marcosotomac
service: alertautec-auth

provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  runtime: python3.11
  memorySize: 1024
  timeout: 30
  websocketsApiName: ${self:service}-ws-${sls:stage}
  websocketsApiRouteSelectionExpression: $request.body.action
  httpApi:
    cors:
      allowedOrigins:
        - "*"
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Requested-With
      allowedMethods:
        - OPTIONS
        - GET
        - POST
        - PATCH
        - PUT
        - DELETE
      maxAge: 300
  environment:
    USERS_TABLE: ${self:custom.usersTableName}
    AUTH_SECRET: ${opt:authSecret, env:AUTH_SECRET, 'dev-secret'}
    SMTP_FROM_ADDRESS: ${opt:smtpFrom, env:SMTP_FROM_ADDRESS, 'marco.soto.m@utec.edu.pe'}
    SMTP_USERNAME: ${opt:smtpUser, env:SMTP_USERNAME, 'marco.soto.m@utec.edu.pe'}
    SMTP_PASSWORD: ${opt:smtpPassword, env:SMTP_PASSWORD, 'qyyt meet kior skgc'}
    SMTP_HOST: ${opt:smtpHost, env:SMTP_HOST, 'smtp.gmail.com'}
    SMTP_PORT: ${opt:smtpPort, env:SMTP_PORT, '587'}
    INCIDENTS_TABLE: ${self:custom.incidentsTableName}
    CONNECTIONS_TABLE: ${self:custom.connectionsTableName}
    CONNECTION_TTL_SECONDS: ${opt:connectionTtl, env:CONNECTION_TTL_SECONDS, '3600'}
    SAGEMAKER_ENDPOINT_NAME: ${opt:sagemakerEndpoint, env:SAGEMAKER_ENDPOINT_NAME, ''}
    MEDIA_BUCKET_NAME: ${self:custom.mediaBucketName}
    ANALYTICS_DATA_BUCKET: ${self:custom.analyticsDataBucketName}
    ANALYTICS_RESULTS_BUCKET: ${self:custom.analyticsResultsBucketName}
    GLUE_DATABASE: ${self:custom.glueDatabase}
    WEBSOCKET_API_ENDPOINT:
      Fn::Join:
        - ""
        - - "https://"
          - Ref: WebsocketsApi
          - ".execute-api."
          - ${self:provider.region}
          - ".amazonaws.com/"
          - ${self:provider.stage}
  iam:
    role: arn:aws:iam::590953801135:role/LabRole

functions:
  register:
    handler: src/handlers/auth/register.handler
    description: Registers an institutional user and stores hashed credentials.
    timeout: 10
    events:
      - httpApi:
          method: post
          path: /auth/register
  login:
    handler: src/handlers/auth/login.handler
    description: Authenticates a user with institutional credentials and issues a session token.
    timeout: 10
    events:
      - httpApi:
          method: post
          path: /auth/login
  createIncident:
    handler: src/handlers/incidents/create.handler
    description: Creates a new incident report with urgency and location metadata.
    timeout: 10
    events:
      - httpApi:
          method: post
          path: /incidents
  listIncidents:
    handler: src/handlers/incidents/list.handler
    description: Lists incidents for dashboards with optional status filtering.
    timeout: 10
    events:
      - httpApi:
          method: get
          path: /incidents
  adminListIncidents:
    handler: src/handlers/incidents/admin_list.handler
    description: Allows authorities to view and filter all active incidents.
    timeout: 10
    events:
      - httpApi:
          method: get
          path: /admin/incidents
  updateIncident:
    handler: src/handlers/incidents/update.handler
    description: Updates incident status or assignment, reserved for personal/autoridad roles.
    timeout: 10
    events:
      - httpApi:
          method: patch
          path: /incidents/{incidentId}
  prioritizeIncident:
    handler: src/handlers/incidents/prioritize.handler
    description: Permite a autoridades priorizar incidentes para el panel.
    timeout: 10
    events:
      - httpApi:
          method: patch
          path: /incidents/{incidentId}/priority
  closeIncident:
    handler: src/handlers/incidents/close.handler
    description: Marca un incidente como resuelto desde el panel administrativo.
    timeout: 10
    events:
      - httpApi:
          method: patch
          path: /incidents/{incidentId}/close
  incidentHistory:
    handler: src/handlers/incidents/history.handler
    description: Devuelve el historial completo de acciones de un incidente.
    timeout: 10
    events:
      - httpApi:
          method: get
          path: /incidents/{incidentId}/history
  requestMediaUpload:
    handler: src/handlers/incidents/request_upload.handler
    description: Genera URLs prefirmadas para subir imágenes o videos de incidentes.
    timeout: 10
    events:
      - httpApi:
          method: post
          path: /incidents/media/upload
  getMediaUrl:
    handler: src/handlers/incidents/get_media_url.handler
    description: Genera URLs firmadas de lectura para archivos multimedia de incidentes.
    timeout: 10
    events:
      - httpApi:
          method: get
          path: /incidents/media/{objectKey+}
  commentIncident:
    handler: src/handlers/incidents/comment.handler
    description: Permite a usuarios dejar comentarios en un incidente.
    timeout: 10
    events:
      - httpApi:
          method: post
          path: /incidents/{incidentId}/comments
  voteSignificance:
    handler: src/handlers/incidents/significance.handler
    description: Incrementa la relevancia (significancia) de un incidente.
    timeout: 10
    events:
      - httpApi:
          method: post
          path: /incidents/{incidentId}/significance
  assignIncident:
    handler: src/handlers/incidents/assign.handler
    description: Asigna un incidente a un miembro del personal (solo autoridades).
    timeout: 10
    events:
      - httpApi:
          method: patch
          path: /incidents/{incidentId}/assign
  listStaff:
    handler: src/handlers/incidents/list_staff.handler
    description: Lista todos los usuarios con rol 'personal' (solo autoridades).
    timeout: 10
    events:
      - httpApi:
          method: get
          path: /staff
  syncIncidentsToS3:
    handler: src/handlers/analytics/sync_to_s3.handler
    description: Sincroniza incidentes de DynamoDB a S3 para análisis con Athena.
    timeout: 300
    memorySize: 2048
    events:
      - schedule: rate(1 hour)
  getAnalytics:
    handler: src/handlers/analytics/get_analytics.handler
    description: Ejecuta queries predefinidos en Athena y retorna métricas (solo autoridad).
    timeout: 60
    memorySize: 1024
    events:
      - httpApi:
          method: get
          path: /analytics/incidents
  exportIncidents:
    handler: src/handlers/analytics/export.handler
    description: Exporta incidentes a PDF, Excel o CSV (solo autoridad).
    timeout: 120
    memorySize: 2048
    events:
      - httpApi:
          method: post
          path: /analytics/export
  predictIncidents:
    handler: src/handlers/analytics/predict.handler
    description: Consulta SageMaker para identificar patrones y predicciones de riesgos.
    timeout: 15
    memorySize: 2048
    events:
      - httpApi:
          method: post
          path: /analytics/predictions
  wsConnect:
    handler: src/handlers/ws/connect.handler
    description: Registers a WebSocket connection associated to the authenticated user.
    events:
      - websocket: $connect
  wsDisconnect:
    handler: src/handlers/ws/disconnect.handler
    description: Cleans up WebSocket connections when clients disconnect.
    events:
      - websocket: $disconnect
  wsDefault:
    handler: src/handlers/ws/default.handler
    description: Handles fallback WebSocket messages (pings/unsupported actions).
    events:
      - websocket: $default
  wsPing:
    handler: src/handlers/ws/ping.handler
    description: Mantiene viva la conexión y renueva el TTL para conexiones activas.
    events:
      - websocket: ping

package:
  patterns:
    - "!node_modules/**"
    - "!venv/**"
    - "!front-hack-cloud/**"
    - "!.git/**"
    - "!*.md"

custom:
  pythonRequirements:
    dockerizePip: true
    layer: true
    slim: true
    strip: false
  usersTableName: ${self:service}-users-${sls:stage}
  incidentsTableName: ${self:service}-incidents-${sls:stage}
  connectionsTableName: ${self:service}-connections-${sls:stage}
  mediaBucketName: ${self:service}-media-${sls:stage}
  analyticsDataBucketName: ${self:service}-analytics-data-${sls:stage}
  analyticsResultsBucketName: ${self:service}-analytics-results-${sls:stage}
  glueDatabase: ${self:service}_analytics_db_${sls:stage}

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.usersTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH
    IncidentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.incidentsTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: incidentId
            AttributeType: S
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: incidentId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: status-index
            KeySchema:
              - AttributeName: status
                KeyType: HASH
            Projection:
              ProjectionType: ALL
    ConnectionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.connectionsTableName}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: connectionId
            AttributeType: S
          - AttributeName: role
            AttributeType: S
          - AttributeName: user
            AttributeType: S
        KeySchema:
          - AttributeName: connectionId
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: role-index
            KeySchema:
              - AttributeName: role
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: user-index
            KeySchema:
              - AttributeName: user
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true
    MediaBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.mediaBucketName}
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders: ["*"]
              AllowedMethods: ["GET", "PUT", "POST", "DELETE", "HEAD"]
              AllowedOrigins: ["*"]
              MaxAge: 3000
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    AnalyticsDataBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.analyticsDataBucketName}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    AnalyticsResultsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.analyticsResultsBucketName}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    GlueDatabase:
      Type: AWS::Glue::Database
      Properties:
        CatalogId: !Ref AWS::AccountId
        DatabaseInput:
          Name: ${self:custom.glueDatabase}
          Description: Database for incidents analytics

    GlueIncidentsTable:
      Type: AWS::Glue::Table
      Properties:
        CatalogId: !Ref AWS::AccountId
        DatabaseName: !Ref GlueDatabase
        TableInput:
          Name: incidents
          Description: Incidents data for analytics
          StorageDescriptor:
            Location: !Sub "s3://${self:custom.analyticsDataBucketName}/incidents/"
            InputFormat: org.apache.hadoop.mapred.TextInputFormat
            OutputFormat: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat
            SerdeInfo:
              SerializationLibrary: org.openx.data.jsonserde.JsonSerDe
            Columns:
              - Name: incidentId
                Type: string
              - Name: type
                Type: string
              - Name: location
                Type: string
              - Name: description
                Type: string
              - Name: urgency
                Type: string
              - Name: priority
                Type: string
              - Name: status
                Type: string
              - Name: reportedBy
                Type: string
              - Name: reporterRole
                Type: string
              - Name: assignedTo
                Type: string
              - Name: createdAt
                Type: string
              - Name: updatedAt
                Type: string
              - Name: significanceCount
                Type: int
              - Name: year
                Type: int
              - Name: month
                Type: int
              - Name: day
                Type: int
          PartitionKeys:
            - Name: year
              Type: int
            - Name: month
              Type: int
            - Name: day
              Type: int
